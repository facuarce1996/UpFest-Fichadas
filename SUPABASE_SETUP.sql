
-- UPFEST CONTROL - SCRIPT DE ACTUALIZACIÓN DE BASE DE DATOS DEFINITIVO v2
-- Ejecutar esto en el SQL Editor de Supabase para habilitar todas las funciones.

-- 1. Agregar columnas necesarias a la tabla de usuarios
ALTER TABLE IF EXISTS public.users ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true;
ALTER TABLE IF EXISTS public.users ADD COLUMN IF NOT EXISTS assigned_locations JSONB DEFAULT '[]';

-- 2. Asegurar que la tabla de sedes tenga los campos correctos
CREATE TABLE IF NOT EXISTS public.locations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  address TEXT,
  city TEXT,
  lat DOUBLE PRECISION,
  lng DOUBLE PRECISION,
  radius_meters INTEGER DEFAULT 100,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. Asegurar tabla de fichadas
CREATE TABLE IF NOT EXISTS public.logs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id TEXT NOT NULL,
  user_name TEXT NOT NULL,
  legajo TEXT,
  timestamp TIMESTAMPTZ NOT NULL,
  type TEXT NOT NULL,
  location_id TEXT,
  location_name TEXT,
  location_status TEXT,
  schedule_status TEXT,
  dress_code_status TEXT,
  identity_status TEXT,
  photo_evidence TEXT,
  ai_feedback TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. Asegurar tabla de configuración
CREATE TABLE IF NOT EXISTS public.app_settings (
  key TEXT PRIMARY KEY,
  value TEXT,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. COMANDO CRÍTICO: Forzar a Supabase a recargar el esquema
-- Esto soluciona el error "Could not find column in schema cache"
NOTIFY pgrst, 'reload schema';
